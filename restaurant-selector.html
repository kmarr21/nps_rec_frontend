<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Select Restaurants: NPS Trip Planner</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: 'Inter', sans-serif; line-height: 1.6; color: #333; background: #f8f8f8;}
        /* header */
        .header {background: #2F4F2F; color: white; padding: 20px 0; position: sticky; top: 0; z-index: 100;}
        .header-container {max-width: 1200px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; align-items: center;}
        .header h1 {font-size: 1.5rem; font-weight: 600;}
        .header-info {font-size: 0.9rem; opacity: 0.9;}
        .back-btn {background: #8B4513; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 500;}
        .back-btn:hover {background: #5d2d0a;}
        
        /* main layout */
        .main-container {max-width: 1200px; margin: 0 auto; padding: 20px; display: grid; grid-template-columns: 350px 1fr; gap: 20px; height: calc(100vh - 100px);}
        
        /* filters sidebar */
        .filters-sidebar {background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow-y: auto;}
        .filters-sidebar h3 {color: #2F4F2F; margin-bottom: 20px; font-size: 1.2rem;}
        .filter-group {margin-bottom: 25px;}
        .filter-group label {display: block; margin-bottom: 8px; font-weight: 600; color: #333;}
        .filter-group select, .filter-group input {width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px;}
        .filter-group select:focus, .filter-group input:focus {outline: none; border-color: #2F4F2F;}
        
        .cuisine-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;}
        .cuisine-item {display: flex; align-items: center; gap: 8px;}
        .cuisine-item input[type="checkbox"] {width: 16px; height: 16px;}
        .cuisine-item label {margin: 0; font-weight: normal; cursor: pointer; font-size: 0.9rem;}
        
        .price-range {display: flex; gap: 10px; margin-top: 10px;}
        .price-btn {padding: 8px 12px; border: 2px solid #ddd; background: white; cursor: pointer; border-radius: 4px; font-size: 0.9rem; transition: all 0.3s ease;}
        .price-btn.selected {background: #2F4F2F; color: white; border-color: #2F4F2F;}
        .price-btn:hover {border-color: #2F4F2F;}
        
        .filter-actions {margin-top: 20px;}
        .apply-filters-btn {width: 100%; background: #2F4F2F; color: white; border: none; padding: 12px; border-radius: 4px; cursor: pointer; font-weight: 600;}
        .apply-filters-btn:hover {background: #1a3a1a;}
        .clear-filters-btn {width: 100%; background: transparent; color: #666; border: 1px solid #ddd; padding: 8px; border-radius: 4px; cursor: pointer; margin-top: 8px;}
        .clear-filters-btn:hover {border-color: #999;}
        
        /* map and results area */
        .map-results-container {display: grid; grid-template-rows: 350px 1fr; gap: 20px;}
        .map-container {background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: relative; overflow: hidden;}
        .map-overlay {position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.95); padding: 8px 12px; border-radius: 4px; font-size: 0.8rem; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.2);}
        
        .results-container {background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;}
        .results-header {padding: 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;}
        .results-header h3 {color: #2F4F2F; font-size: 1.2rem;}
        .results-count {color: #666; font-size: 0.9rem;}
        
        .results-list {max-height: 400px; overflow-y: auto;}
        .restaurant-card {padding: 20px; border-bottom: 1px solid #eee; cursor: pointer; transition: all 0.3s ease; position: relative;}
        .restaurant-card:hover {background: #f9f9f9;}
        .restaurant-card:last-child {border-bottom: none;}
        .restaurant-card.selected {background: #e8f5e8; border-left: 4px solid #2F4F2F;}
        
        .restaurant-header {display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;}
        .restaurant-name {font-weight: 600; color: #333; font-size: 1.1rem;}
        .restaurant-rating {color: #ff9500; font-weight: 500;}
        .restaurant-info {display: flex; gap: 15px; margin-bottom: 8px; color: #666; font-size: 0.9rem;}
        .restaurant-address {color: #888; font-size: 0.9rem;}
        
        .loading {text-align: center; padding: 40px; color: #666;}
        .no-results {text-align: center; padding: 40px; color: #666;}
        .error {text-align: center; padding: 40px; color: #e74c3c; background: #fdf2f2; border-radius: 6px; margin: 20px;}
        
        /* meal selection modal */
        .modal-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; align-items: center; justify-content: center;}
        .modal-overlay.show {display: flex;}
        .modal {background: white; padding: 30px; border-radius: 8px; max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0,0,0,0.3);}
        .modal h3 {color: #2F4F2F; margin-bottom: 20px;}
        .meal-options {display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0;}
        .meal-btn {padding: 15px; border: 2px solid #ddd; background: white; cursor: pointer; border-radius: 4px; text-align: center; font-weight: 500; transition: all 0.3s ease;}
        .meal-btn:hover {border-color: #2F4F2F; background: #f9f9f9;}
        .meal-btn.selected {background: #2F4F2F; color: white; border-color: #2F4F2F;}
        .modal-actions {display: flex; gap: 10px; justify-content: flex-end;}
        .modal-btn {padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;}
        .modal-btn-primary {background: #2F4F2F; color: white;}
        .modal-btn-primary:hover {background: #1a3a1a;}
        .modal-btn-primary:disabled {background: #ccc; cursor: not-allowed;}
        .modal-btn-secondary {background: #ddd; color: #333;}
        .modal-btn-secondary:hover {background: #ccc;}
        
        @media (max-width: 768px) {
            .main-container {grid-template-columns: 1fr; grid-template-rows: auto auto 1fr; height: auto;}
            .map-results-container {grid-template-rows: 250px 1fr;}
            .cuisine-grid {grid-template-columns: 1fr;}
            .price-range {flex-wrap: wrap;}}
    </style>
</head>
<body>
    <div class="header">
        <div class="header-container">
            <div>
                <h1>Select Restaurants</h1>
                <div class="header-info" id="headerInfo">Loading...</div>
            </div>
            <button class="back-btn" onclick="goBack()">← Back to Itinerary</button>
        </div>
    </div>
    <div class="main-container">
        <!-- filters sidebar -->
        <div class="filters-sidebar">
            <h3>Filter Restaurants</h3>
            <div class="filter-group">
                <label>Search Radius</label>
                <select id="radiusSelect">
                    <option value="10000">10 km</option>
                    <option value="25000">25 km</option>
                    <option value="50000" selected>50 km (Recommended)</option>
                    <option value="75000">75 km</option>
                    <option value="100000">100 km</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Minimum Rating</label>
                <select id="ratingSelect">
                    <option value="0">Any Rating</option>
                    <option value="3">3+ Stars</option>
                    <option value="3.5">3.5+ Stars</option>
                    <option value="4" selected>4+ Stars</option>
                    <option value="4.5">4.5+ Stars</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Price Range</label>
                <div class="price-range">
                    <div class="price-btn selected" data-price="1">$</div>
                    <div class="price-btn selected" data-price="2">$$</div>
                    <div class="price-btn selected" data-price="3">$$$</div>
                    <div class="price-btn selected" data-price="4">$$$$</div>
                </div>
            </div>
            <div class="filter-group">
                <label>
                    <input type="checkbox" id="openNowCheck"> Currently Open
                </label>
            </div>
            <div class="filter-group">
                <label>Cuisine Type</label>
                <div class="cuisine-grid">
                    <div class="cuisine-item"><input type="checkbox" id="italian" value="italian"><label for="italian">Italian</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="mexican" value="mexican"><label for="mexican">Mexican</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="american" value="american"><label for="american">American</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="asian" value="asian"><label for="asian">Asian</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="chinese" value="chinese"><label for="chinese">Chinese</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="japanese" value="japanese"><label for="japanese">Japanese</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="thai" value="thai"><label for="thai">Thai</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="indian" value="indian"><label for="indian">Indian</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="seafood" value="seafood"><label for="seafood">Seafood</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="pizza" value="pizza"><label for="pizza">Pizza</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="french" value="french"><label for="french">French</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="greek" value="greek"><label for="greek">Greek</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="steakhouse" value="steakhouse"><label for="steakhouse">Steakhouse</label></div>
                    <div class="cuisine-item"><input type="checkbox" id="vegetarian" value="vegetarian"><label for="vegetarian">Vegetarian</label></div>
                </div>
            </div>
            <div class="filter-actions">
                <button class="apply-filters-btn" onclick="searchRestaurants()">Apply Filters</button>
                <button class="clear-filters-btn" onclick="clearFilters()">Clear All</button>
            </div>
        </div>
        <!-- map + results -->
        <div class="map-results-container">
            <div class="map-container">
                <div id="mapElement" style="width: 100%; height: 100%;"></div>
                <div class="map-overlay" id="mapOverlay">Loading...</div>
            </div>
            <div class="results-container">
                <div class="results-header">
                    <h3>Restaurants</h3>
                    <div class="results-count" id="resultsCount">Searching...</div>
                </div>
                <div class="results-list" id="resultsList">
                    <div class="loading">Searching for restaurants...</div>
                </div>
            </div>
        </div>
    </div>
    <!-- meal selection -->
    <div class="modal-overlay" id="mealModal">
        <div class="modal">
            <h3>Add to Itinerary</h3>
            <p>Select meal type for <strong id="selectedRestaurantName"></strong>:</p>
            <div class="meal-options">
                <div class="meal-btn" data-meal="breakfast">Breakfast</div>
                <div class="meal-btn" data-meal="lunch">Lunch</div>
                <div class="meal-btn" data-meal="dinner">Dinner</div>
                <div class="meal-btn" data-meal="other">Other</div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeMealModal()">Cancel</button>
                <button class="modal-btn modal-btn-primary" onclick="addRestaurantToTrip()" disabled id="addRestaurantBtn">Add to Trip</button>
            </div>
        </div>
    </div>
    <!-- gm javascript API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=GOOGLE_MAPS_API_KEY&libraries=places&callback=initMap" async defer></script>
    <script>
        const BACKEND_URL = 'https://nps-rec-backend.onrender.com';
        let tripData = {};
        let selectedRestaurant = null;
        let selectedMealType = null;
        let currentRestaurants = [];
        let map = null;
        let mapMarkers = [];
        let parkMarker = null;
        // initialize page
        document.addEventListener('DOMContentLoaded', function(){
            loadTripData();
            setupEventListeners();});

        function loadTripData() {
            const urlParams = new URLSearchParams(window.location.search);
            tripData = {
                day: parseInt(urlParams.get('day')),
                parkCode: urlParams.get('parkCode'),
                parkName: urlParams.get('parkName'),
                lat: parseFloat(urlParams.get('lat')),
                lng: parseFloat(urlParams.get('lng')),
                tripId: urlParams.get('tripId')};

            // update header
            document.getElementById('headerInfo').textContent = `${tripData.parkName} • Day ${tripData.day + 1}`;
        }

        function setupEventListeners() {
            // price range buttons
            document.querySelectorAll('.price-btn').forEach(btn => {btn.addEventListener('click', function() {this.classList.toggle('selected');});});

            // meal type select
            document.querySelectorAll('.meal-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.meal-btn').forEach(b => b.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMealType = this.dataset.meal;
                    document.getElementById('addRestaurantBtn').disabled = false;});});
        }

        // initialize Google map
        function initMap() {
            if (!tripData.lat || !tripData.lng) {
                setTimeout(initMap, 100); // wait for tripData to load!!
                return;}

            map = new google.maps.Map(document.getElementById('mapElement'), {
                center: { lat: tripData.lat, lng: tripData.lng },
                zoom: calculateZoomForRadius(parseInt(document.getElementById('radiusSelect').value)),
                mapTypeId: 'roadmap',
                styles: [{featureType: 'poi', elementType: 'labels', stylers: [{visibility: 'off'}]}]
            });

            // add park marker
            parkMarker = new google.maps.Marker({
                position: {lat: tripData.lat, lng: tripData.lng},
                map: map,
                title: tripData.parkName,
                icon: {url: 'https://maps.google.com/mapfiles/ms/icons/green-dot.png', scaledSize: new google.maps.Size(32, 32)}
            });
            // initial search
            searchRestaurants();
        }

        function calculateZoomForRadius(radius) {
            if (radius <= 10000) return 12;
            else if (radius <= 25000) return 10;
            else if (radius <= 50000) return 9;
            else if (radius <= 75000) return 8;
            else return 7;
        }

        async function searchRestaurants() {
            const filters = collectFilters();
            console.log('Searching with filters:', filters);
            // update map zoom for new radius
            if (map) {map.setZoom(calculateZoomForRadius(filters.radius));}

            // clear existing markers
            clearMapMarkers();
            // show loading
            document.getElementById('resultsList').innerHTML = '<div class="loading">Searching for restaurants...</div>';
            document.getElementById('resultsCount').textContent = 'Searching...';
            document.getElementById('mapOverlay').textContent = 'Loading...';

            try {
                const response = await fetch(`${BACKEND_URL}/api/restaurants/search-restaurants-near-park`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        latitude: tripData.lat,
                        longitude: tripData.lng,
                        radius: filters.radius,
                        cuisines: filters.cuisines,
                        prices: filters.prices,
                        rating: filters.rating,
                        openNow: filters.openNow})
                });
                if (!response.ok) {throw new Error(`HTTP ${response.status}: Failed to search restaurants`);}
                const data = await response.json();
                currentRestaurants = data.restaurants;
                displayResults(data);
                updateMapMarkers(data);
            } catch (error) {
                console.error('Restaurant search error:', error);
                document.getElementById('resultsList').innerHTML = '<div class="error">Error loading restaurants. Please try again.</div>';
                document.getElementById('resultsCount').textContent = 'Error';
                document.getElementById('mapOverlay').textContent = 'Error loading';}
        }

        function collectFilters() {
            const radius = parseInt(document.getElementById('radiusSelect').value);
            const rating = parseFloat(document.getElementById('ratingSelect').value);
            const openNow = document.getElementById('openNowCheck').checked;
            const cuisines = [];
            document.querySelectorAll('.cuisine-grid input:checked').forEach(cb => {cuisines.push(cb.value);});
            const prices = [];
            document.querySelectorAll('.price-btn.selected').forEach(btn => {prices.push(parseInt(btn.dataset.price));});
            return {radius, rating, openNow, cuisines, prices};
        }

        function displayResults(data) {
            const resultsList = document.getElementById('resultsList');
            const resultsCount = document.getElementById('resultsCount');

            if (data.restaurants.length === 0) {
                resultsList.innerHTML = '<div class="no-results">No restaurants found. Try adjusting your filters.</div>';
                resultsCount.textContent = 'No restaurants found';
                return;}

            resultsCount.textContent = `${data.restaurants.length} restaurants found`;

            const html = data.restaurants.map(restaurant => `
                <div class="restaurant-card" onclick="highlightRestaurant('${restaurant.place_id}')" data-place-id="${restaurant.place_id}">
                    <div class="restaurant-header">
                        <div class="restaurant-name">${restaurant.name}</div>
                        <div class="restaurant-rating">★ ${restaurant.rating}</div>
                    </div>
                    <div class="restaurant-info">
                        <span>${'$'.repeat(restaurant.price_level)}</span>
                        <span>${restaurant.cuisine_types.slice(0, 2).join(', ') || 'Restaurant'}</span>
                        ${restaurant.business_status === 'OPERATIONAL' ? '' : '<span style="color: #ff3b30;">Temporarily Closed</span>'}
                    </div>
                    <div class="restaurant-address">${restaurant.address}</div>
                </div>`).join('');
            resultsList.innerHTML = html;
        }

        function clearMapMarkers() {
            mapMarkers.forEach(marker => marker.setMap(null));
            mapMarkers = [];
        }

        function updateMapMarkers(data) {
            if (!map) return;
            const radius = parseInt(document.getElementById('radiusSelect').value);
            document.getElementById('mapOverlay').textContent = 
                `${data.restaurants.length} restaurants within ${radius/1000}km`;

            // add restaurant markers!!
            data.restaurants.forEach(restaurant => {
                if (restaurant.location) {
                    const marker = new google.maps.Marker({
                        position: { lat: restaurant.location.lat, lng: restaurant.location.lng },
                        map: map,
                        title: restaurant.name,
                        icon: {url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png', scaledSize: new google.maps.Size(24, 24)}});
                    // click marker to select restaurant
                    marker.addListener('click', () => {selectRestaurant(restaurant.place_id);});
                    mapMarkers.push(marker);}
            });

            // adjust map bounds to show all markers if needed
            if (data.map_bounds) {
                const bounds = new google.maps.LatLngBounds(
                    new google.maps.LatLng(data.map_bounds.southwest.lat, data.map_bounds.southwest.lng),
                    new google.maps.LatLng(data.map_bounds.northeast.lat, data.map_bounds.northeast.lng));
                map.fitBounds(bounds);}
        }

        function highlightRestaurant(placeId) {
            // remove old highlights
            document.querySelectorAll('.restaurant-card').forEach(card => {card.classList.remove('selected');});

            //highlight selected card
            const selectedCard = document.querySelector(`[data-place-id="${placeId}"]`);
            if (selectedCard) {selectedCard.classList.add('selected'); selectRestaurant(placeId);}
        }

        function selectRestaurant(placeId) {
            selectedRestaurant = currentRestaurants.find(r => r.place_id === placeId);
            if (selectedRestaurant) {
                document.getElementById('selectedRestaurantName').textContent = selectedRestaurant.name;
                document.getElementById('mealModal').classList.add('show');
                selectedMealType = null;
                document.getElementById('addRestaurantBtn').disabled = true;
                document.querySelectorAll('.meal-btn').forEach(btn => btn.classList.remove('selected'));}
        }

        function closeMealModal() {
            document.getElementById('mealModal').classList.remove('show');
            selectedRestaurant = null;
            selectedMealType = null;
            // remove card highlight
            document.querySelectorAll('.restaurant-card').forEach(card => {card.classList.remove('selected');});
        }

        function addRestaurantToTrip() {
            if (!selectedRestaurant || !selectedMealType) return;
            // get current trip data
            const currentTrip = JSON.parse(localStorage.getItem('nps_current_trip'));
            if (!currentTrip) {
                alert('Trip data not found. Please go back and try again.');
                return;}

            // initialize restaurants object (if needed only)
            if (!currentTrip.restaurants) {currentTrip.restaurants = {};}

            const dayKey = tripData.day.toString();
            if (!currentTrip.restaurants[dayKey]) {currentTrip.restaurants[dayKey] = [];}

            // check if already have 4 restaurants for this day
            if (currentTrip.restaurants[dayKey].length >= 4) {
                alert('You can only add up to 4 restaurants per day.');
                return;}

            // check if restaurant already added for this day
            const alreadyAdded = currentTrip.restaurants[dayKey].find(r => r.place_id === selectedRestaurant.place_id);
            if (alreadyAdded) {
                alert('This restaurant is already added to this day.');
                return;}

            // add restaurant to trip
            currentTrip.restaurants[dayKey].push({
                place_id: selectedRestaurant.place_id,
                name: selectedRestaurant.name,
                rating: selectedRestaurant.rating,
                price_level: selectedRestaurant.price_level,
                address: selectedRestaurant.address,
                meal_type: selectedMealType,
                cuisine_types: selectedRestaurant.cuisine_types,
                added: new Date().toISOString()});

            // save updated trip
            localStorage.setItem('nps_current_trip', JSON.stringify(currentTrip));
            // close modal and show success
            closeMealModal();
            alert(`${selectedRestaurant.name} added to your ${selectedMealType} plans!`);
        }

        function clearFilters() {
            document.getElementById('radiusSelect').value = '50000';
            document.getElementById('ratingSelect').value = '4';
            document.getElementById('openNowCheck').checked = false;
            document.querySelectorAll('.cuisine-grid input').forEach(cb => cb.checked = false);
            document.querySelectorAll('.price-btn').forEach(btn => btn.classList.add('selected'));
            searchRestaurants();
        }

        function goBack() {
            window.location.href = 'itinerary.html';
        }
    </script>
</body>
</html>