<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Final Itinerary: ParkMatch</title>
    <link rel="icon" type="image/png" href="logos/logo_symbol.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: 'Inter', sans-serif; line-height: 1.6; color: #333; background: #f8f8f8; min-height: 100vh;}
        /* navbar */
        .navbar {background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: fixed; top: 0; width: 100%;
            z-index: 1000; padding: 1rem 0;}
        .nav-container {max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between;
            align-items: center; padding: 0 2rem;}
        .logo {font-size: 1.8rem; font-weight: bold; color: #2F4F2F;}
        .nav-links {display: flex; list-style: none; gap: 2rem;}
        .nav-links a {text-decoration: none; color: #333; font-weight: 500; transition: color 0.3s ease;}
        .nav-links a:hover {color: #2F4F2F;}
        .nav-links a.active {color: #2F4F2F; border-bottom: 2px solid #2F4F2F;}

        /* logo */
        .logo {font-size: 1.8rem; font-weight: bold; color: #2F4F2F; display: flex; align-items: center;}

        /* main content */
        .main-content {padding: 100px 0 50px; max-width: 1000px; margin: 0 auto; padding-left: 2rem; padding-right: 2rem;}
        
        /* header */
        .header {text-align: center; margin-bottom: 40px;}
        .header h1 {font-size: 2.5rem; color: #2F4F2F; margin-bottom: 1rem; font-weight: 700;}
        .header p {font-size: 1.2rem; color: #666; max-width: 600px; margin: 0 auto;}
        .completion-badge {background: #28a745; color: white; padding: 8px 16px; border-radius: 20px; 
            display: inline-block; font-weight: 600; margin-top: 15px; font-size: 0.9rem;}

        /* trip overview */
        .trip-overview {background: white; padding: 40px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 30px;}
        .trip-title {font-size: 2rem; color: #2F4F2F; margin-bottom: 10px; font-weight: 700;}
        .trip-subtitle {color: #666; font-size: 1.1rem; margin-bottom: 30px;}
        
        /* preferences display */
        .preferences-display {background: white; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 30px;}
        .preferences-display h3 {font-size: 1.4rem; color: #2F4F2F; margin-bottom: 20px; font-weight: 600;}
        .preferences-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;}
        .preference-group h4 {color: #333; margin-bottom: 10px; font-weight: 600;}
        .preference-tags {display: flex; flex-wrap: wrap; gap: 5px;}
        .preference-tag {background: #f0f0f0; padding: 4px 8px; font-size: 0.8rem; color: #333;}
        .preference-value {color: #666; font-weight: 500;}

        /* trip timeline */
        .trip-timeline {margin: 30px 0;}
        .timeline-item {margin-bottom: 30px; padding: 25px; background: #f9f9f9; border: 2px solid #2F4F2F;}
        .timeline-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
        .timeline-date {background: #2F4F2F; color: white; padding: 8px 15px; font-weight: 600;}
        .timeline-park {font-size: 1.3rem; font-weight: 600; color: #333;}
        .timeline-content {margin-bottom: 20px;}
        .timeline-content p {color: #666; margin-bottom: 10px;}
        .weather-preview {background: #8B4513; color: white; padding: 5px 10px; font-size: 0.8rem; display: inline-block;}

        /* day detail sections */
        .day-detail-section {margin: 20px 0; padding: 20px; background: white; border: 1px solid #ddd; border-radius: 8px;}
        .day-header {font-size: 1.2rem; color: #2F4F2F; margin-bottom: 15px; font-weight: 600; border-bottom: 2px solid #2F4F2F; padding-bottom: 5px;}
        .day-sections {display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;}
        .section {background: #f9f9f9; padding: 15px; border-radius: 6px;}
        .section h5 {color: #333; margin-bottom: 10px; font-weight: 600;}
        .section-placeholder {color: #999; font-style: italic; text-align: center; padding: 20px 0;}

        /* accommodation display */
        .accommodation-display {padding: 15px; background: white; border-radius: 4px; border: 1px solid #ddd; text-align: center;}
        .accommodation-type {font-weight: 600; color: #2F4F2F; font-size: 1.1rem;}

        /* restaurants display */
        .restaurants-list {display: flex; flex-direction: column; gap: 8px;}
        .restaurant-item {display: flex; align-items: center; gap: 10px; padding: 10px; background: white; border-radius: 4px; border: 1px solid #ddd;}
        .meal-tag {padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; color: white; text-transform: capitalize;}
        .meal-breakfast {background: #ff9500;}
        .meal-lunch {background: #34c759;}
        .meal-dinner {background: #007aff;}
        .meal-other {background: #8e8e93;}
        .restaurant-name {flex: 1; font-weight: 500; color: #333;}
        .restaurant-rating {color: #ff9500; font-weight: 500;}
        .restaurant-details {font-size: 0.8rem; color: #666;}

        /* summary stats */
        .trip-stats {background: white; padding: 30px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); margin-bottom: 30px;}
        .trip-stats h3 {font-size: 1.4rem; color: #2F4F2F; margin-bottom: 20px; font-weight: 600;}
        .stats-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;}
        .stat-item {text-align: center; padding: 20px; background: #f9f9f9; border-radius: 8px;}
        .stat-number {font-size: 2rem; font-weight: bold; color: #2F4F2F; display: block;}
        .stat-label {color: #666; font-weight: 500; margin-top: 5px;}

        /* action buttons */
        .action-section {text-align: center; padding: 40px 0;}
        .button-row {display: flex; justify-content: center; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 15px;}
        .btn {background: #2F4F2F; color: white; border: none; padding: 15px 30px; font-size: 1.1rem;
            font-weight: bold; cursor: pointer; transition: all 0.3s ease;}
        .btn:hover {background: #1a3a1a; transform: translateY(-2px);}
        .btn-secondary {background: #8B4513;}
        .btn-secondary:hover {background: #5d2d0a;}
        .btn-success {background: #28a745;}
        .btn-success:hover {background: #1e7e34;}
        .btn-danger {background: #dc3545;}
        .btn-danger:hover {background: #c82333;}

        /* disclaimer */
        .disclaimer {background: #f8f9fa; padding: 20px; margin: 30px 0; border-left: 4px solid #2F4F2F; text-align: left;}
        .disclaimer strong {color: #2F4F2F;}

        /* responsive */
        @media (max-width: 768px) {
            .nav-container {padding: 0 1rem;}
            .nav-links {display: none;}
            .main-content {padding: 100px 1rem 50px;}
            .trip-overview, .preferences-display, .trip-stats {padding: 25px;}
            .timeline-header {flex-direction: column; gap: 10px; align-items: flex-start;}
            .day-sections {grid-template-columns: 1fr;}
            .button-row {flex-direction: column; gap: 10px;}
            .btn {width: 100%; max-width: 300px;}
            .preferences-grid, .stats-grid {grid-template-columns: 1fr;}
            .restaurant-item {flex-wrap: wrap; gap: 5px;}
            .restaurant-name {flex-basis: 100%; order: -1;}}
    </style>
</head>
<body>
    <!-- nav -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">
                <img src="logos/logo_symbol.png" alt="ParkMatch" style="height: 60px; margin-right: 12px;">
                <span>ParkMatch</span>
            </div>
            <ul class="nav-links">
                <li><a href="index.html">Home</a></li>
                <li><a href="#" class="active">Final Itinerary</a></li>
                <li><a href="#" onclick="return handleHowItWorksClick(event)">How It Works</a></li>
            </ul>
        </div>
    </nav>
    <div class="main-content">
        <!-- header -->
        <div class="header">
            <h1>Your Final Itinerary</h1>
            <p>Your complete national park adventure is ready!</p>
            <div class="completion-badge">✓ Trip Complete</div>
        </div>
        <!-- trip overview -->
        <div class="trip-overview">
            <div class="trip-title" id="tripName">Your Trip Name</div>
            <div class="trip-subtitle" id="tripDates">Trip dates and duration</div>
            <!-- prefs display -->
            <div class="preferences-display">
                <h3>Your Preferences</h3>
                <div class="preferences-grid">
                    <div class="preference-group">
                        <h4>Activities</h4>
                        <div class="preference-tags" id="activities"></div>
                    </div>
                    <div class="preference-group">
                        <h4>Topics</h4>
                        <div class="preference-tags" id="topics"></div>
                    </div>
                    <div class="preference-group">
                        <h4>Climate</h4>
                        <div class="preference-value" id="climate"></div>
                    </div>
                    <div class="preference-group">
                        <h4>Crowds</h4>
                        <div class="preference-value" id="crowds"></div>
                    </div>
                </div>
            </div>
            <!-- trip timeline -->
            <div class="trip-timeline" id="tripTimeline">
                <!-- timeline loaded here -->
            </div>
        </div>
        <!-- trip statss -->
        <div class="trip-stats">
            <h3>Trip Summary</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-number" id="totalDays">0</span>
                    <div class="stat-label">Total Days</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalParks">0</span>
                    <div class="stat-label">Parks Visited</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="totalRestaurants">0</span>
                    <div class="stat-label">Restaurants Selected</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="accommodationDays">0</span>
                    <div class="stat-label">Accommodation Days</div>
                </div>
            </div>
        </div>
        <!-- disclaimer -->
        <div class="disclaimer">
            <strong>Planning Disclaimer:</strong> This tool helps you organize your trip planning but cannot make actual reservations. 
            You'll need to book accommodations, campsites, and make park reservations directly through official websites and services.
        </div>
        <!-- action buttons -->
        <div class="action-section">
            <div class="button-row">
                <button class="btn btn-success" onclick="exportItinerary()">Export Itinerary</button>
            </div>
            <div class="button-row">
                <button class="btn btn-secondary" onclick="editDetails()">← Edit Details</button>
                <button class="btn btn-secondary" onclick="goHome()">Back to Home</button>
                <button class="btn btn-danger" onclick="deleteTrip()">Delete Trip</button>
            </div>
        </div>
    </div>
    <script>
        let currentTrip = null;
        let PARKS_DATA = [];
        // initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            await loadParksData();
            loadTripData();});

        //load parks data
        async function loadParksData() {
            try {
                const recommendedParks = localStorage.getItem('nps_recommended_parks');
                if (recommendedParks) {
                    PARKS_DATA = JSON.parse(recommendedParks);
                    console.log('Parks data loaded:', PARKS_DATA.length, 'parks');}
                else {
                    console.log('No recommended parks found');
                    PARKS_DATA = [];}
            } catch (error) {
                console.error('Error loading parks data:', error);
                PARKS_DATA = [];}
        }

        // load + display trip data
        function loadTripData() {
            const tripData = localStorage.getItem('nps_current_trip');
            if (!tripData) {
                alert('No trip found. Redirecting to home page.');
                window.location.href = 'index.html';
                return;}

            currentTrip = JSON.parse(tripData);
            console.log('Loaded trip data:', currentTrip);
            displayTripOverview();
            displayTripStats();
            createTimeline();
        }

        // display trip overview
        function displayTripOverview() {
            document.getElementById('tripName').textContent = currentTrip.name;
            
            const startDate = new Date(currentTrip.questionnaire.startDate).toLocaleDateString();
            const endDate = new Date(currentTrip.questionnaire.endDate).toLocaleDateString();
            const duration = currentTrip.questionnaire.duration || 'Multiple days';
            document.getElementById('tripDates').textContent = `${startDate} - ${endDate} • ${duration}`;
            // display prefs
            const prefs = currentTrip.questionnaire;
            
            const activitiesEl = document.getElementById('activities');
            if (prefs.activities && prefs.activities.length > 0) {
                activitiesEl.innerHTML = prefs.activities.map(activity => `<span class="preference-tag">${activity}</span>`).join('');}
            else {activitiesEl.innerHTML = '<span class="preference-value">None selected</span>';}
            
            const topicsEl = document.getElementById('topics');
            if (prefs.topics && prefs.topics.length > 0) {
                topicsEl.innerHTML = prefs.topics.map(topic => `<span class="preference-tag">${topic}</span>`).join('');}
            else {topicsEl.innerHTML = '<span class="preference-value">None selected</span>';}
            
            document.getElementById('climate').textContent = prefs.climate || 'Not specified';
            document.getElementById('crowds').textContent = prefs.crowds || 'Not specified';
        }

        // display trip statistics
        function displayTripStats() {
            const startDate = new Date(currentTrip.questionnaire.startDate);
            const endDate = new Date(currentTrip.questionnaire.endDate);
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            
            // count restaurants
            let totalRestaurants = 0;
            if (currentTrip.restaurants) {Object.values(currentTrip.restaurants).forEach(dayRestaurants => {totalRestaurants += dayRestaurants.length;});}

            //count accommodation days
            let accommodationDays = 0;
            if (currentTrip.accommodations) {accommodationDays = Object.keys(currentTrip.accommodations).length;}

            document.getElementById('totalDays').textContent = totalDays;
            document.getElementById('totalParks').textContent = currentTrip.parks.length;
            document.getElementById('totalRestaurants').textContent = totalRestaurants;
            document.getElementById('accommodationDays').textContent = accommodationDays;
        }

        // create timeline
        function createTimeline() {
            const timeline = document.getElementById('tripTimeline');
            timeline.innerHTML = '';

            if (!currentTrip || !currentTrip.parks || currentTrip.parks.length === 0) {
                timeline.innerHTML = '<p>No parks selected for this trip.</p>';
                return;}

            const startDate = new Date(currentTrip.questionnaire.startDate);
            const endDate = new Date(currentTrip.questionnaire.endDate);
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const dayToPark = {};

            // assign days to parks
            if (currentTrip.dayAssignments && Object.keys(currentTrip.dayAssignments).length > 0) {
                for (let day = 0; day < totalDays; day++) {dayToPark[day] = currentTrip.dayAssignments[day] || 0;}
            } else {
                const parksCount = currentTrip.parks.length;
                const daysPerPark = Math.floor(totalDays / parksCount);
                const extraDays = totalDays % parksCount;
                let currentDay = 0;
                currentTrip.parks.forEach((parkCode, parkIndex) => {
                    const parkDays = daysPerPark + (parkIndex < extraDays ? 1 : 0);
                    for (let i = 0; i < parkDays; i++) {
                        dayToPark[currentDay] = parkIndex;
                        currentDay++;}});
            }

            // group consecutive days by park
            const parkSegments = [];
            let currentSegment = null;

            for (let day = 0; day < totalDays; day++) {
                const parkIndex = dayToPark[day];
                const currentParkDate = new Date(startDate);
                currentParkDate.setDate(currentParkDate.getDate() + day);

                if (!currentSegment || currentSegment.parkIndex !== parkIndex) {
                    if (currentSegment) {parkSegments.push(currentSegment);}
                    currentSegment = {
                        parkIndex: parkIndex,
                        startDay: day,
                        endDay: day,
                        startDate: new Date(currentParkDate),
                        endDate: new Date(currentParkDate),
                        days: [day]
                    };}
                else {
                    currentSegment.endDay = day;
                    currentSegment.endDate = new Date(currentParkDate);
                    currentSegment.days.push(day);}
            }
            if (currentSegment) {parkSegments.push(currentSegment);}

            // create timeline items
            parkSegments.forEach(segment => {
                const park = PARKS_DATA.find(p => p.parkCode === currentTrip.parks[segment.parkIndex]);
                if (!park) return;
                const timelineItem = document.createElement('div');
                timelineItem.className = 'timeline-item';
                //get weather data
                const weekIndex = getWeekOfYear(segment.startDate);
                const temperature = park.weather && park.weather.temperature ? 
                    Math.round(park.weather.temperature[weekIndex] || 70) : 70;

                const dateRange = segment.startDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) + 
                    (segment.days.length > 1 ? ' - ' + segment.endDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}) : '');

                //day-by-day breakdown
                const dayBreakdown = segment.days.map(day => {
                    const dayDate = new Date(startDate);
                    dayDate.setDate(dayDate.getDate() + day);
                    const dayKey = day.toString();
                    const accommodation = currentTrip.accommodations?.[dayKey] || null;
                    const restaurants = currentTrip.restaurants?.[dayKey] || [];

                    return {
                        dayIndex: day,
                        date: dayDate,
                        dateStr: dayDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'}),
                        accommodation: accommodation,
                        restaurants: restaurants};
                });

                timelineItem.innerHTML = `
                    <div class="timeline-header">
                        <div class="timeline-park">${park.fullName}</div>
                        <div class="timeline-date">${dateRange} (${segment.days.length} day${segment.days.length > 1 ? 's' : ''})</div>
                    </div>
                    <div class="timeline-content">
                        <p>${park.description}</p>
                        <div class="weather-preview">Expected: ${temperature}°F</div>
                    </div>
                    ${dayBreakdown.map(day => `
                        <div class="day-detail-section">
                            <h4 class="day-header">${day.dateStr}</h4>
                            <div class="day-sections">
                                <div class="section">
                                    <h5>Accommodation</h5>
                                    ${day.accommodation ? 
                                        `<div class="accommodation-display">
                                            <div class="accommodation-type">${day.accommodation.type}</div>
                                        </div>` :
                                        `<div class="section-placeholder">No accommodation selected</div>`}
                                </div>
                                <div class="section">
                                    <h5>Dining (${day.restaurants.length} restaurant${day.restaurants.length !== 1 ? 's' : ''})</h5>
                                    ${day.restaurants.length > 0 ? 
                                        `<div class="restaurants-list">
                                            ${day.restaurants.map(restaurant => `
                                                <div class="restaurant-item">
                                                    <span class="meal-tag meal-${restaurant.meal_type}">${restaurant.meal_type}</span>
                                                    <span class="restaurant-name">${restaurant.name}</span>
                                                    <span class="restaurant-rating">★${restaurant.rating}</span>
                                                </div>`).join('')}
                                        </div>` :
                                        `<div class="section-placeholder">No restaurants selected</div>`}
                                </div>
                            </div>
                        </div>`).join('')}`;
                timeline.appendChild(timelineItem);});
        }

        // helper function for week calculations
        function getWeekOfYear(date) {
            const start = new Date(date.getFullYear(), 0, 1);
            const days = Math.floor((date - start) / (24 * 60 * 60 * 1000));
            return Math.min(Math.floor(days / 7), 51);
        }

        //export itin
        function exportItinerary() {
            //simple text export for now!! (do we want to do Excel later?? thoughts?)
            let exportText = `${currentTrip.name}\n`;
            exportText += `${new Date(currentTrip.questionnaire.startDate).toLocaleDateString()} - ${new Date(currentTrip.questionnaire.endDate).toLocaleDateString()}\n\n`;
            
            exportText += `PREFERENCES:\n`;
            exportText += `Activities: ${currentTrip.questionnaire.activities.join(', ')}\n`;
            exportText += `Topics: ${currentTrip.questionnaire.topics.join(', ')}\n`;
            exportText += `Climate: ${currentTrip.questionnaire.climate}\n`;
            exportText += `Crowds: ${currentTrip.questionnaire.crowds}\n\n`;

            exportText += `ITINERARY:\n`;
            
            const startDate = new Date(currentTrip.questionnaire.startDate);
            const endDate = new Date(currentTrip.questionnaire.endDate);
            const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;

            for (let day = 0; day < totalDays; day++) {
                const dayDate = new Date(startDate);
                dayDate.setDate(dayDate.getDate() + day);
                const dayKey = day.toString();
                exportText += `\nDay ${day + 1} - ${dayDate.toLocaleDateString()}:\n`;
                // accommodation
                const accommodation = currentTrip.accommodations?.[dayKey];
                if (accommodation) {exportText += `  Accommodation: ${accommodation.type}\n`;}
                // restaurants
                const restaurants = currentTrip.restaurants?.[dayKey] || [];
                if (restaurants.length > 0) {
                    exportText += `  Dining:\n`;
                    restaurants.forEach(restaurant => {exportText += `    ${restaurant.meal_type}: ${restaurant.name} (★${restaurant.rating})\n`;});}
            }
            // create & download file
            const blob = new Blob([exportText], {type: 'text/plain'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentTrip.name.replace(/[^a-z0-9]/gi, '_')}_itinerary.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        //nav functions
        function editDetails() {
            window.location.href = 'itinerary.html';
        }

        function goHome() {
            //set flag that we're in final itinerary mode!!
            localStorage.setItem('nps_in_final_mode', 'true');
            window.location.href = 'index.html';
        }

        function deleteTrip() {
        if (confirm('Are you sure you want to delete your trip? This cannot be undone.')) {
            localStorage.removeItem('nps_current_trip');
            localStorage.removeItem('nps_questionnaire_data');
            localStorage.removeItem('nps_park_selection');
            localStorage.removeItem('nps_in_final_mode'); //clear final mode flag..
            alert('Trip deleted successfully! Redirecting to homepage...');
            window.location.href = 'index.html';
        }
    }

        function handleHowItWorksClick(event) {
            event.preventDefault();
            window.location.href = 'index.html#how-it-works';
            return false;
        }
    </script>
</body>
</html>